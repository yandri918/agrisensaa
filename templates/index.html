<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Agrisensa - Ekosistem Cerdas</title>
    <!-- Menambahkan Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PENTING: Tambahkan library Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary-color: #2e7d32; --primary-light: #4caf50; --background-color: #f8f9fa; --card-background: #ffffff; --text-color: #212529; --text-muted: #6c757d; --border-color: #dee2e6; --shadow: 0 4px 6px rgba(0,0,0,0.05); }
        body { font-family: 'Inter', sans-serif; max-width: 900px; margin: 20px auto; padding: 15px; background-color: var(--background-color); color: var(--text-color); }
        .header { text-align: center; margin-bottom: 40px; }
        h1 { color: var(--primary-color); font-weight: 700; font-size: 2.5em; }
        .price-ticker-container { background-color: var(--text-color); color: white; padding: 10px 0; margin-bottom: 30px; border-radius: 8px; overflow: hidden; white-space: nowrap; }
        .price-ticker-content { display: inline-block; padding-left: 100%; animation: scroll-left 40s linear infinite; }
        .ticker-item { display: inline-block; margin: 0 25px; }
        .ticker-item .name { font-weight: 500; }
        .ticker-item .price { font-weight: 700; color: var(--primary-light); margin-left: 8px; }
        @keyframes scroll-left { 0% { transform: translateX(0%); } 100% { transform: translateX(-100%); } }
        .module { background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 12px; padding: 30px; margin-bottom: 30px; box-shadow: var(--shadow); }
        h2 { display: flex; align-items: center; gap: 12px; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-top: 0; font-size: 1.5em; font-weight: 600; }
        h3 { color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 25px; font-weight: 600; }
        h4 { color: #333; margin-top: 15px; margin-bottom: 5px; }
        button, .option-button { background-color: var(--primary-light); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; width: 100%; transition: all 0.2s; margin-bottom: 10px; }
        button:hover, .option-button:hover { background-color: var(--primary-color); transform: translateY(-2px); }
        .result-box { margin-top: 20px; padding: 20px; border-radius: 8px; background-color: #f8f9fa; line-height: 1.6; border: 1px solid var(--border-color); }
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 1em; box-sizing: border-box; }
        label { font-weight: 500; margin-bottom: 8px; display: block; }
        ul { padding-left: 20px; } li { margin-bottom: 10px; }
        .item-list { list-style-type: none; padding-left: 0; }
        .price-item, .fertilizer-item, .pdf-item, .shap-item, .plan-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 12px 0; }
        .item-name, .plan-item-label { font-weight: 500; }
        .item-value, .plan-item-value { font-size: 1.1em; color: var(--primary-color); font-weight: 600; }
        .pdf-item a { text-decoration: none; color: var(--primary-color); font-weight: 500;}
        .pdf-item a:hover { text-decoration: underline; }
        .tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-button { background: none; border: none; padding: 12px 18px; cursor: pointer; font-size: 1em; font-weight: 500; border-bottom: 3px solid transparent; color: var(--text-muted); }
        .tab-button.active { border-bottom: 3px solid var(--primary-light); color: var(--primary-color); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .strategy-cycle { border-left: 3px solid var(--primary-light); padding-left: 20px; margin-bottom: 25px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border-color); }
        th { background-color: #f8f9fa; font-weight: 600; }
        td.cost { text-align: right; font-weight: 500; }
        .total-cost { font-weight: bold; text-align: right; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .shap-positive { color: #2e7d32; font-weight: bold; }
        .shap-negative { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold" style="color: var(--primary-color);">Dasbor Intelijen Agrisensa</h1>
            <p class="text-lg" style="color: var(--text-muted);">Ekosistem Cerdas Anda untuk Pertanian Presisi</p>
        </header>

        <div class="price-ticker-container">
            <div class="price-ticker-content" id="price-ticker-content"><span>Memuat data harga...</span></div>
        </div>

        <!-- Modul 1: Dokter Tanaman -->
        <div class="module">
            <h2>üî¨ Modul 1: Dokter Tanaman</h2>
            <form id="upload-form">
                <label for="file-input">Unggah foto daun untuk diagnosis BWD.</label>
                <input type="file" id="file-input" name="file" accept="image/*" required>
                <button type="submit">Analisis Daun</button>
            </form>
            <div id="result-bwd" class="result-box"><p>Hasil analisis akan muncul di sini.</p></div>
        </div>

        <!-- Modul 2: Asisten Agronomi -->
        <div class="module">
            <h2>üë®‚Äçüî¨ Modul 2: Asisten Agronomi</h2>
            <form id="recommendation-form">
                <label for="ph-input">pH Tanah:</label><input type="number" id="ph-input" step="0.1" placeholder="Contoh: 6.5" required>
                <label for="bwd-input">Skor BWD (dari Modul 1):</label><input type="number" id="bwd-input" placeholder="Akan terisi otomatis" readonly required>
                <label for="moisture-input">Kelembaban Tanah (%):</label><input type="number" id="moisture-input" placeholder="Contoh: 60" required>
                <label for="age-input">Umur Tanaman (Hari):</label><input type="number" id="age-input" placeholder="Contoh: 30" required>
                <button type="submit">Dapatkan Rekomendasi</button>
            </form>
            <div id="result-recommendation" class="result-box"><p>Rekomendasi pemupukan akan muncul di sini.</p></div>
        </div>

        <!-- Modul 3: Analisis NPK Manual -->
        <div class="module">
            <h2>üß™ Modul 3: Analisis NPK Manual</h2>
            <form id="npk-form">
                <label for="n-input">Nitrogen (N) (ppm):</label><input type="number" id="n-input" placeholder="Contoh: 150" required>
                <label for="p-input">Fosfor (P) (ppm):</label><input type="number" id="p-input" placeholder="Contoh: 30" required>
                <label for="k-input">Kalium (K) (ppm):</label><input type="number" id="k-input" placeholder="Contoh: 200" required>
                <button type="submit">Analisis NPK</button>
            </form>
            <div id="result-npk" class="result-box"><p>Hasil analisis NPK akan muncul di sini.</p></div>
        </div>

        <!-- Modul 4: Intelijen Harga Pasar -->
        <div class="module">
            <h2>üìà Modul 4: Intelijen Harga Pasar</h2>
            <form id="price-form">
                <label for="price-commodity-select">Pilih Komoditas:</label>
                <select id="price-commodity-select" required>
                    <option value="" disabled selected>-- Pilih Komoditas --</option>
                    <option value="cabai_merah_keriting">Cabai Merah Keriting</option>
                    <option value="bawang_merah">Bawang Merah</option>
                </select>
                <button type="submit">Cek Harga</button>
            </form>
            <div id="result-price" class="result-box"><p>Data harga akan muncul di sini.</p></div>
        </div>
        
        <!-- Modul 5: Basis Pengetahuan Budidaya -->
        <div class="module">
            <h2>üìñ Modul 5: Basis Pengetahuan Budidaya</h2>
            <form id="knowledge-form">
                <label for="knowledge-commodity-select">Pilih Komoditas:</label>
                <select id="knowledge-commodity-select" required>
                    <option value="" disabled selected>-- Pilih Komoditas --</option>
                    <option value="padi">Padi</option>
                    <option value="cabai">Cabai</option>
                    <option value="jagung">Jagung</option>
                </select>
            </form>
            <div id="result-knowledge" class="result-box"><p>Informasi budidaya akan muncul di sini.</p></div>
        </div>
        
        <!-- Modul 6: Pusat Pengetahuan Pertanian -->
        <div class="module">
            <h2>üî¨ Modul 6: Pusat Pengetahuan Pertanian</h2>
            <div class="tabs">
                <button class="tab-button active" onclick="openTab(event, 'pupuk-npk', this)">Pupuk NPK</button>
                <button class="tab-button" onclick="openTab(event, 'agen-hayati', this)">Agen Hayati</button>
                <button class="tab-button" onclick="openTab(event, 'poc-zpt', this)">POC & ZPT</button>
            </div>
            <div id="pupuk-npk" class="tab-content active knowledge-section">
                <h3>Pupuk Dasar (N, P, K)</h3><p>Memahami tiga pilar utama nutrisi tanaman untuk pertumbuhan optimal.</p><h4>Nitrogen (N) - Unsur Pertumbuhan</h4><ul><li><strong>Fungsi Fisiologis:</strong> Bertanggung jawab atas pertumbuhan vegetatif (daun, batang) dan memberikan warna hijau pekat pada daun sebagai komponen utama klorofil.</li><li><strong>Gejala Kekurangan:</strong> Daun tua menguning (klorosis) dimulai dari ujung daun, pertumbuhan tanaman kerdil.</li><li><strong>Sumber Kimia:</strong> Urea, ZA, NPK.</li><li><strong>Sumber Organik:</strong> Kompos, pupuk kandang (terutama dari unggas), leguminosa, MOL Keong.</li></ul><h4>Fosfor (P) - Unsur Energi & Akar</h4><ul><li><strong>Fungsi Fisiologis:</strong> Berperan sebagai inti transfer energi seluler (ATP), merangsang pertumbuhan akar yang kuat, mempercepat pembungaan dan pematangan buah/biji.</li><li><strong>Gejala Kekurangan:</strong> Pertumbuhan kerdil, warna daun ungu kemerahan, pembungaan dan pembuahan terhambat.</li><li><strong>Sumber Kimia:</strong> SP-36, TSP, NPK.</li><li><strong>Sumber Organik:</strong> Guano (kotoran kelelawar), tepung tulang, pupuk kandang.</li></ul><h4>Kalium (K) - Unsur Kualitas & Ketahanan</h4><ul><li><strong>Fungsi Fisiologis:</strong> Berfungsi sebagai "regulator" yang memperkuat batang, meningkatkan kualitas buah (rasa, warna, daya simpan), dan meningkatkan ketahanan terhadap stres kekeringan dan penyakit.</li><li><strong>Gejala Kekurangan:</strong> Tepi daun tua terlihat seperti terbakar (kering kecoklatan), buah mudah rontok dan kualitasnya rendah.</li><li><strong>Sumber Kimia:</strong> KCL (MOP), ZK, NPK.</li><li><strong>Sumber Organik:</strong> Sabut kelapa, bonggol pisang, abu kayu (tidak dari kayu yang dicat).</li></ul>
            </div>
            <div id="agen-hayati" class="tab-content knowledge-section">
                 <h3>Agen Hayati: "Pasukan" Pelindung & Penyubur Tanah</h3><p>Mikroorganisme bermanfaat yang menjadi fondasi pertanian organik dan regeneratif.</p><h4>Trichoderma sp.</h4><ul><li><strong>Fungsi Utama:</strong> Fungisida Hayati (Biofungisida).</li><li><strong>Mekanisme Kerja:</strong> Melalui kompetisi ruang di perakaran (*rhizosphere*), **mikoparasitisme** (melilit dan menghancurkan jamur patogen), dan antibiosis (mengeluarkan zat anti-jamur).</li><li><strong>Target:</strong> Sangat efektif mencegah penyakit layu *Fusarium*, busuk akar *Pythium*, dan rebah semai *Rhizoctonia*.</li></ul><h4>PGPR (Plant Growth-Promoting Rhizobacteria)</h4><ul><li><strong>Fungsi Utama:</strong> Pupuk Hayati & Stimulan Pertumbuhan.</li><li><strong>Mekanisme Kerja:</strong> Menambat Nitrogen dari udara, **melarutkan Fosfor** yang terikat di tanah dengan enzim fosfatase, dan memproduksi fitohormon (seperti Auksin) serta **siderofor** (pengikat besi).</li><li><strong>Target:</strong> Meningkatkan ketersediaan N & P, serta merangsang sistem perakaran menjadi lebih lebat.</li></ul><h4>Mikoriza</h4><ul><li><strong>Fungsi Utama:</strong> Perluasan Sistem Perakaran (Biofertilizer).</li><li><strong>Mekanisme Kerja:</strong> Hifa jamur bersimbiosis dengan akar dan berfungsi sebagai perpanjangan akar, memperluas area penyerapan air dan unsur hara **imobil** (seperti Fosfor) hingga ratusan kali lipat.</li><li><strong>Target:</strong> Meningkatkan ketahanan tanaman terhadap kekeringan dan efisiensi penyerapan pupuk P secara signifikan.</li></ul>
            </div>
            <div id="poc-zpt" class="tab-content knowledge-section">
                <h3>POC & ZPT: Suplemen & Hormon Alami</h3><p>Nutrisi tambahan dan stimulasi pertumbuhan untuk memaksimalkan potensi tanaman.</p><h4>MOL (Mikroorganisme Lokal)</h4><ul><li><strong>Penjelasan:</strong> Larutan hasil fermentasi bahan-bahan organik lokal (keong, bonggol pisang, dll.) yang kaya akan mikroorganisme, enzim, dan unsur hara mikro. Berfungsi sebagai pupuk cair sekaligus dekomposer.</li></ul><h4>Auksin</h4><ul><li><strong>Fungsi Fisiologis:</strong> Hormon yang fokus pada **pemanjangan sel** dan **inisiasi akar**.</li><li><strong>Aplikasi Praktis:</strong> Merangsang pertumbuhan akar pada bibit dan stek.</li><li><strong>Sumber Alami:</strong> Tauge (kecambah kacang hijau), rebung bambu.</li></ul><h4>Sitokinin</h4><ul><li><strong>Fungsi Fisiologis:</strong> Hormon yang fokus pada **pembelahan sel**.</li><li><strong>Aplikasi Praktis:</strong> Merangsang pertumbuhan tunas samping (membuat tanaman rimbun) dan menunda penuaan daun. Sangat kaya pada **daun kelor (mengandung Zeatin)**.</li><li><strong>Sumber Alami:</strong> Air kelapa, daun kelor.</li></ul><h4>Giberelin</h4><ul><li><strong>Fungsi Fisiologis:</strong> Hormon serbaguna untuk **mematahkan dormansi** dan **pembesaran organ**.</li><li><strong>Aplikasi Praktis:</strong> Mempercepat perkecambahan biji, merangsang pembungaan serempak, dan memperbesar ukuran buah.</li><li><strong>Sumber Alami:</strong> Bonggol pisang, ganggang laut.</li></ul>
            </div>
        </div>

        <!-- Modul 7: Kalkulator Pupuk Holistik -->
        <div class="module">
            <h2>üßÆ Modul 7: Kalkulator Pupuk Holistik</h2>
            <form id="fertilizer-calculator-form">
                <label for="fert-commodity-select">Pilih Komoditas:</label>
                <select id="fert-commodity-select" required>
                    <option value="" disabled selected>-- Pilih Komoditas --</option>
                    <option value="padi">Padi</option>
                    <option value="cabai">Cabai</option>
                    <option value="jagung">Jagung</option>
                </select>
                <label for="area-input">Luas Lahan (meter persegi):</label>
                <input type="number" id="area-input" placeholder="Contoh: 1000" required>
                <label for="fert-ph-input">pH Tanah Saat Ini:</label>
                <input type="number" id="fert-ph-input" step="0.1" placeholder="Contoh: 5.8" required>
                <button type="submit">Hitung Kebutuhan</button>
            </form>
            <div id="result-fertilizer" class="result-box"><p>Hasil perhitungan akan muncul di sini.</p></div>
        </div>

        <!-- Modul 8: Pustaka Dokumen -->
        <div class="module">
            <h2>üìÇ Modul 8: Pustaka Dokumen</h2>
            <form id="pdf-upload-form">
                 <label for="pdf-file-input">Pilih File PDF untuk Diunggah:</label>
                <input type="file" id="pdf-file-input" name="file" accept=".pdf" required>
                <button type="submit">Unggah Dokumen</button>
            </form>
            <div id="pdf-upload-status" class="result-box" style="display:none;"></div>
            <h3>Dokumen Tersimpan:</h3>
            <div id="pdf-list" class="result-box"><p>Memuat daftar dokumen...</p></div>
        </div>

        <!-- Modul 9: Dasbor Rekomendasi Terpadu -->
        <div class="module">
            <h2>üí° Modul 9: Dasbor Rekomendasi Terpadu</h2>
            <form id="integrated-recommendation-form">
                 <label for="ketinggian-select">Ketinggian Lahan:</label>
                <select id="ketinggian-select" required>
                    <option value="" disabled selected>-- Pilih Ketinggian --</option>
                    <option value="dataran_rendah">Dataran Rendah (< 700 mdpl)</option>
                    <option value="dataran_tinggi">Dataran Tinggi (> 700 mdpl)</option>
                </select>
                <label for="iklim-select">Tipe Iklim:</label>
                <select id="iklim-select" required>
                    <option value="" disabled selected>-- Pilih Tipe Iklim --</option>
                    <option value="tropis">Tropis</option>
                    <option value="subtropis">Subtropis</option>
                </select>
                <label for="fase-select">Fase Pertumbuhan Saat Ini:</label>
                <select id="fase-select" required>
                    <option value="" disabled selected>-- Pilih Fase --</option>
                    <option value="vegetatif">Vegetatif</option>
                    <option value="generatif">Generatif</option>
                </select>
                <label for="masalah-select">Masalah Utama:</label>
                <select id="masalah-select" required>
                    <option value="none" selected>Tidak Ada Masalah</option>
                    <option value="thrips">Hama Thrips</option>
                    <option value="antraknosa">Jamur Antraknosa</option>
                </select>
                <button type="submit">Dapatkan Rekomendasi</button>
            </form>
            <div id="result-integrated" class="result-box"><p>Rekomendasi terpadu akan muncul di sini.</p></div>
        </div>

        <!-- Modul 10: Strategi Penyemprotan Cerdas -->
        <div class="module">
            <h2>üõ°Ô∏è Modul 10: Strategi Penyemprotan Cerdas</h2>
            <form id="spraying-strategy-form">
                <label for="pest-select">Pilih Hama/Penyakit Target:</label>
                <select id="pest-select" required>
                    <option value="" disabled selected>-- Pilih Target --</option>
                    <option value="thrips">Hama Thrips</option>
                </select>
                <button type="submit">Dapatkan Strategi</button>
            </form>
            <div id="result-spraying" class="result-box"><p>Rencana strategis akan muncul di sini.</p></div>
        </div>

        <!-- Modul 11: Analisis Tren Harga -->
        <div class="module">
            <h2>üìä Modul 11: Analisis Tren Harga</h2>
            <form id="historical-price-form">
                <label for="historical-commodity-select">Pilih Komoditas:</label>
                <select id="historical-commodity-select" required>
                    <option value="" disabled selected>-- Pilih Komoditas --</option>
                    <option value="cabai_merah_keriting">Cabai Merah Keriting</option>
                    <option value="bawang_merah">Bawang Merah</option>
                    <option value="jagung_pipilan">Jagung Pipilan</option>
                    <option value="beras_medium">Beras Medium</option>
                </select>
                <label for="time-range-select">Pilih Rentang Waktu:</label>
                <select id="time-range-select" required>
                    <option value="30" selected>30 Hari Terakhir</option>
                    <option value="90">90 Hari Terakhir</option>
                </select>
                <button type="submit">Tampilkan Grafik</button>
            </form>
            <div id="result-historical-price" class="result-box">
                <p>Grafik tren harga akan muncul di sini.</p>
                <canvas id="price-chart" style="margin-top: 20px;"></canvas>
            </div>
        </div>
        
        <!-- Modul 12: Ensiklopedia Komoditas Cerdas -->
        <div class="module">
            <h2>üå∂Ô∏è Modul 12: Ensiklopedia Komoditas Cerdas</h2>
            <form id="guide-form">
                <label for="guide-commodity-select">Pilih Komoditas:</label>
                <select id="guide-commodity-select" required>
                    <option value="" disabled selected>-- Pilih Komoditas --</option>
                    <option value="cabai">Cabai</option>
                </select>
                <button type="submit">Tampilkan Panduan</button>
            </form>
            <div id="result-guide" class="result-box" style="display:none;"></div>
        </div>

        <!-- Modul 13: Pusat Pengetahuan pH Tanah -->
        <div class="module">
            <h2>üß™ Modul 13: Pusat Pengetahuan pH Tanah</h2>
            <p>Pahami variabel utama yang mengontrol kesuburan tanah dan efektivitas pemupukan.</p>
            <button id="show-ph-info-btn">Tampilkan Informasi Lengkap</button>
            <div id="result-ph-info" class="result-box" style="display:none;"></div>
        </div>

        <!-- Modul 14: Rekomendasi Tanaman Cerdas -->
        <div class="module">
            <h2>üå± Modul 14: Rekomendasi Tanaman Cerdas (Agrimap AI)</h2>
            <p>Masukkan data tanah dan iklim Anda untuk mendapatkan rekomendasi tanaman yang paling sesuai dari model AI kami.</p>
            <form id="crop-recommendation-form">
                <div class="input-grid">
                    <div>
                        <label for="crop-n-input">Kandungan Nitrogen (N) di Tanah:</label>
                        <input type="number" id="crop-n-input" step="any" placeholder="Contoh: 90" required>
                    </div>
                    <div>
                        <label for="crop-p-input">Kandungan Fosfor (P) di Tanah:</label>
                        <input type="number" id="crop-p-input" step="any" placeholder="Contoh: 42" required>
                    </div>
                     <div>
                        <label for="crop-k-input">Kandungan Kalium (K) di Tanah:</label>
                        <input type="number" id="crop-k-input" step="any" placeholder="Contoh: 43" required>
                    </div>
                    <div>
                        <label for="crop-temp-input">Suhu Rata-rata (¬∞C):</label>
                        <input type="number" id="crop-temp-input" step="any" placeholder="Contoh: 20.8" required>
                    </div>
                    <div>
                        <label for="crop-humidity-input">Kelembaban Udara Rata-rata (%):</label>
                        <input type="number" id="crop-humidity-input" step="any" placeholder="Contoh: 82.1" required>
                    </div>
                     <div>
                        <label for="crop-ph-input">pH Tanah:</label>
                        <input type="number" id="crop-ph-input" step="any" placeholder="Contoh: 6.5" required>
                    </div>
                </div>
                <label for="crop-rainfall-input">Curah Hujan Tahunan (mm):</label>
                <input type="number" id="crop-rainfall-input" step="any" placeholder="Contoh: 202.9" required>
                
                <button type="submit">Dapatkan Rekomendasi Tanaman</button>
            </form>
            <div id="result-crop" class="result-box"><p>Rekomendasi tanaman akan muncul di sini.</p></div>
        </div>
        
        <!-- Modul 15: Prediksi Hasil Panen Cerdas -->
        <div class="module">
            <h2>üìà Modul 15: Prediksi Hasil Panen Cerdas</h2>
            <p>Masukkan data kondisi lahan dan iklim Anda untuk mendapatkan estimasi potensi hasil panen dari model AI kami.</p>
            <form id="yield-prediction-form">
                <div class="input-grid">
                    <div>
                        <label for="yield-n-input">Nitrogen (N) (kg/ha):</label>
                        <input type="number" id="yield-n-input" step="any" placeholder="Contoh: 138" required>
                    </div>
                    <div>
                        <label for="yield-p-input">Fosfor (P) (kg/ha):</label>
                        <input type="number" id="yield-p-input" step="any" placeholder="Contoh: 165" required>
                    </div>
                     <div>
                        <label for="yield-k-input">Kalium (K) (kg/ha):</label>
                        <input type="number" id="yield-k-input" step="any" placeholder="Contoh: 339" required>
                    </div>
                    <div>
                        <label for="yield-temp-input">Suhu (¬∞C):</label>
                        <input type="number" id="yield-temp-input" step="any" placeholder="Contoh: 21" required>
                    </div>
                    <div>
                        <label for="yield-rainfall-input">Curah Hujan (mm):</label>
                        <input type="number" id="yield-rainfall-input" step="any" placeholder="Contoh: 487" required>
                    </div>
                     <div>
                        <label for="yield-ph-input">pH Tanah:</label>
                        <input type="number" id="yield-ph-input" step="any" placeholder="Contoh: 6.5" required>
                    </div>
                </div>
                <button type="submit">Prediksi Hasil Panen</button>
            </form>
            <div id="result-yield" class="result-box"><p>Prediksi hasil panen akan muncul di sini.</p></div>
        </div>
        
        <!-- Modul 16: Intelijen Prediktif (XAI) -->
        <div class="module">
            <h2>üß† Modul 16: Intelijen Prediktif (XAI)</h2>
            <p>Dapatkan prediksi hasil panen beserta penjelasan 'mengapa' di balik angka tersebut.</p>
            <form id="xai-yield-prediction-form">
                <div class="input-grid">
                    <div><label for="xai-nitrogen">Nitrogen (N) (kg/ha):</label><input type="number" id="xai-nitrogen" step="any" placeholder="Contoh: 138" required></div>
                    <div><label for="xai-phosphorus">Fosfor (P) (kg/ha):</label><input type="number" id="xai-phosphorus" step="any" placeholder="Contoh: 165" required></div>
                    <div><label for="xai-potassium">Kalium (K) (kg/ha):</label><input type="number" id="xai-potassium" step="any" placeholder="Contoh: 339" required></div>
                    <div><label for="xai-temperature">Suhu (¬∞C):</label><input type="number" id="xai-temperature" step="any" placeholder="Contoh: 21" required></div>
                    <div><label for="xai-rainfall">Curah Hujan (mm):</label><input type="number" id="xai-rainfall" step="any" placeholder="Contoh: 487" required></div>
                    <div><label for="xai-ph">pH Tanah:</label><input type="number" id="xai-ph" step="any" placeholder="Contoh: 6.5" required></div>
                </div>
                <button type="submit">Buat Prediksi & Analisis</button>
            </form>
            <div id="result-xai-yield" class="result-box" style="display:none;"></div>
        </div>

        <!-- Modul 17: Kalkulator Konversi Pupuk -->
        <div class="module">
            <h2>‚öñÔ∏è Modul 17: Kalkulator Konversi Pupuk</h2>
            <p>Ubah kebutuhan unsur hara murni (kg) menjadi jumlah pupuk yang harus Anda siapkan.</p>
            <form id="fertilizer-conversion-form">
                <div class="input-grid">
                    <div>
                        <label for="nutrient-needed-select">Unsur Hara yang Dibutuhkan:</label>
                        <select id="nutrient-needed-select" required>
                            <option value="N">Nitrogen (N)</option>
                            <option value="P">Fosfor (P)</option>
                            <option value="K">Kalium (K)</option>
                        </select>
                    </div>
                    <div>
                        <label for="nutrient-amount-input">Jumlah Kebutuhan (kg):</label>
                        <input type="number" id="nutrient-amount-input" step="any" placeholder="Contoh: 10" required>
                    </div>
                </div>
                <label for="fertilizer-type-select">Sumber Pupuk yang Akan Digunakan:</label>
                <select id="fertilizer-type-select" required>
                    <option value="" disabled selected>-- Pilih Jenis Pupuk --</option>
                    <option value="urea">Urea</option>
                    <option value="sp36">SP-36</option>
                    <option value="kcl">KCL (MOP)</option>
                    <option value="npk_mutiara">NPK Mutiara (16-16-16)</option>
                </select>
                <button type="submit">Hitung Kebutuhan Pupuk</button>
            </form>
            <div id="result-fertilizer-conversion" class="result-box"><p>Hasil perhitungan akan muncul di sini.</p></div>
        </div>
        
        <!-- Modul 18: Diagnostik Gejala Cerdas -->
        <div class="module">
            <h2>üßë‚Äç‚öïÔ∏è Modul 18: Diagnostik Gejala Cerdas</h2>
            <p>Jawab serangkaian pertanyaan untuk mendiagnosis masalah pada tanaman Anda, langkah demi langkah.</p>
            <button id="start-diagnostic-btn">Mulai Diagnostik</button>
            <div id="diagnostic-questions" class="result-box" style="display:none;"></div>
            <div id="diagnostic-result" class="result-box" style="display:none;"></div>
        </div>

        <!-- Modul 19: Perencana Hasil Panen (AI) -->
        <div class="module">
            <h2>üéØ Modul 19: Perencana Hasil Panen (AI)</h2>
            <p>Tentukan target hasil panen Anda, dan biarkan AI menyusun resep kondisi lahan yang dibutuhkan untuk mencapainya.</p>
            <form id="yield-plan-form">
                <div class="input-grid">
                    <div>
                        <label for="plan-commodity-select">Pilih Komoditas:</label>
                        <select id="plan-commodity-select" required>
                            <option value="umum" selected>Umum (Semua Tanaman)</option>
                        </select>
                    </div>
                    <div>
                        <label for="plan-target-yield-input">Target Hasil Panen (ton/ha):</label>
                        <input type="number" id="plan-target-yield-input" step="any" placeholder="Contoh: 7.5" required>
                    </div>
                </div>
                <button type="submit" class="mt-4">Buat Rencana Lahan</button>
            </form>
            <div id="result-yield-plan" class="result-box"><p>Rencana kondisi lahan akan muncul di sini.</p></div>
        </div>
        
        <!-- Modul 21: Analis Risiko Keberhasilan (AI) -->
        <div class="module">
                <h2>‚öñÔ∏è Modul 21: Analis Risiko Keberhasilan (AI)</h2>
                <p class="text-gray-600 mb-6">Masukkan parameter rencana tanam Anda untuk mendapatkan analisis probabilitas keberhasilan dari model Logistic Regression kami.</p>
                <form id="success-prediction-form">
                    <h3 class="text-lg font-semibold mb-2">Parameter Kondisi</h3>
                    <div class="input-grid">
                        <div><label for="sp-nitrogen">Nitrogen (kg/ha):</label><input type="number" id="sp-nitrogen" step="any" required placeholder="138"></div>
                        <div><label for="sp-phosphorus">Fosfor (kg/ha):</label><input type="number" id="sp-phosphorus" step="any" required placeholder="165"></div>
                        <div><label for="sp-potassium">Kalium (kg/ha):</label><input type="number" id="sp-potassium" step="any" required placeholder="339"></div>
                        <div><label for="sp-temperature">Suhu (¬∞C):</label><input type="number" id="sp-temperature" step="any" required placeholder="21"></div>
                        <div><label for="sp-rainfall">Curah Hujan (mm):</label><input type="number" id="sp-rainfall" step="any" required placeholder="487"></div>
                        <div><label for="sp-ph">pH Tanah:</label><input type="number" id="sp-ph" step="any" required placeholder="6.5"></div>
                    </div>
                    <h3 class="text-lg font-semibold mt-6 mb-2">Parameter Praktik Budidaya (SOP)</h3>
                    <div class="input-grid">
                         <div>
                            <label for="sp-benih">Penggunaan Benih Bersertifikat:</label>
                            <select id="sp-benih" required><option value="1">Ya</option><option value="0">Tidak</option></select>
                        </div>
                        <div>
                            <label for="sp-organik">Aplikasi Pupuk Organik Dasar:</label>
                            <select id="sp-organik" required><option value="1">Ya</option><option value="0">Tidak</option></select>
                        </div>
                         <div>
                            <label for="sp-gulma">Manajemen Gulma Terjadwal:</label>
                            <select id="sp-gulma" required><option value="1">Ya</option><option value="0">Tidak</option></select>
                        </div>
                    </div>
                    <button type="submit" class="mt-4">Analisis Risiko</button>
                </form>
                <div id="result-success-prediction" class="result-box"><p>Hasil analisis risiko akan muncul di sini.</p></div>
        </div>

        <!-- Modul 20: Dokter Tanaman Canggih (Roboflow AI) -->
        <div class="module">
            <h2>ü©∫ Modul 20: Dokter Tanaman Canggih (Roboflow AI)</h2>
            <p class="text-gray-600 mb-6">Unggah foto tanaman Anda untuk mendapatkan diagnosis penyakit yang detail dari model Computer Vision canggih yang di-hosting di Roboflow.</p>
            <form id="advanced-disease-form">
                <label for="disease-image-input">Pilih Gambar Tanaman:</label>
                <input type="file" id="disease-image-input" name="file" accept="image/png, image/jpeg" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                <button type="submit" class="mt-4">Dapatkan Diagnosis Canggih</button>
            </form>
            <div id="result-advanced-disease" class="result-box"><p>Hasil diagnosis akan muncul di sini.</p></div>
        </div>

    </div>

    <script>
        // --- Fungsi global untuk mengelola tab ---
        function openTab(evt, tabName, element) { 
            const moduleDiv = element.closest('.module');
            if (!moduleDiv) return;
            const tabcontent = moduleDiv.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
            const tablinks = moduleDiv.getElementsByClassName("tab-button");
            for (let i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
            const targetTab = moduleDiv.querySelector(`#${tabName}`);
            if (targetTab) { targetTab.style.display = "block"; }
            if (evt && evt.currentTarget) {
                evt.currentTarget.className += " active";
            }
        }

        // --- Event listener utama ---
        // HANYA ADA SATU DOMCONTENTLOADED UNTUK MENGHINDARI BUG
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ AgriSensa: DOMContentLoaded fired! Initializing all 21 modules...');
            
            const baseUrl = window.location.origin;
            const apiPrefix = '/api/legacy'; // Sesuai dengan arsitektur blueprint Anda
            console.log('üìç Base URL:', baseUrl);
            console.log('üõ†Ô∏è API Prefix:', apiPrefix);
            
            const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);

            // --- Logika untuk Ticker Harga ---
            const tickerContent = document.getElementById('price-ticker-content');
            async function fetchTickerData() {
                try {
                    const response = await fetch(`${baseUrl}${apiPrefix}/get-ticker-prices`);
                    const responseData = await response.json();
                    if (responseData.success) {
                        let tickerHtml = '';
                        const tickerItems = [...responseData.data, ...responseData.data];
                        tickerItems.forEach(item => {
                            tickerHtml += `<div class="ticker-item"><span class="name">${item.name}:</span><span class="price">${formatRupiah(item.price)}/${item.unit}</span></div>`;
                        });
                        tickerContent.innerHTML = tickerHtml;
                    }
                } catch (error) { console.error("Gagal memuat data ticker:", error); }
            }
            if(tickerContent) {
                fetchTickerData();
                setInterval(fetchTickerData, 60000);
            }

            // --- Logika untuk Modul 1 (Analisis BWD) ---
            const formBwd = document.getElementById('upload-form'), resultBwdDiv = document.getElementById('result-bwd'), bwdInput = document.getElementById('bwd-input');
            if(formBwd) { 
                formBwd.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    console.log('üìù Modul 1: BWD Analysis: Form submitted!');
                    resultBwdDiv.innerHTML = '<p>Menganalisis gambar...</p>';
                    const formData = new FormData(formBwd);
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/analyze`, { method: 'POST', body: formData });
                        const data = await response.json();
                        if (data.success) {
                            resultBwdDiv.innerHTML = `<p><strong>Skor BWD:</strong> ${data.bwd_score} | <strong>Kepercayaan:</strong> ${data.confidence_percent}%</p>`;
                            if(bwdInput) bwdInput.value = data.bwd_score;
                        } else { resultBwdDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.message || data.error}</p>`; }
                    } catch (error) { resultBwdDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Gagal terhubung.</p>`; }
                });
            }

            // --- Logika untuk Modul 2 (Rekomendasi Pupuk) ---
            const formRec = document.getElementById('recommendation-form'), resultRecDiv = document.getElementById('result-recommendation');
            if(formRec) {
                formRec.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    console.log('üìù Modul 2: Recommendation: Form submitted!');
                    resultRecDiv.innerHTML = '<p>Menghitung rekomendasi...</p>';
                    const requestData = { ph_tanah: formRec.querySelector('#ph-input').value, skor_bwd: bwdInput.value, kelembaban_tanah: formRec.querySelector('#moisture-input').value, umur_tanaman_hari: formRec.querySelector('#age-input').value, };
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/recommendation`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) });
                        const data = await response.json();
                        if (data.success) {
                            let html = `<h3>${data.recommendation.rekomendasi_utama}</h3><ul class="item-list">`;
                            for (const [key, value] of Object.entries(data.recommendation.rekomendasi_pupuk_ml)) { html += `<li class="fertilizer-item"><span class="item-name">${key}</span><span class="item-value">${value}</li>`; }
                            html += '</ul>';
                            if (data.recommendation.peringatan_penting.length > 0) {
                                html += '<h4 style="color: orange;">Peringatan:</h4><ul>';
                                data.recommendation.peringatan_penting.forEach(w => { html += `<li>${w}</li>`; });
                                html += '</ul>';
                            }
                            resultRecDiv.innerHTML = html;
                        } else { resultRecDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`; }
                    } catch (error) { resultRecDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Gagal terhubung.</p>`; }
                });
            }

            // --- Logika untuk Modul 3 (Analisis NPK Manual) ---
            const formNpk = document.getElementById('npk-form'), resultNpkDiv = document.getElementById('result-npk');
            if(formNpk) {
                formNpk.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    console.log('üìù Modul 3: NPK Analysis: Form submitted!');
                    resultNpkDiv.innerHTML = '<p>Menganalisis data NPK...</p>';
                    const requestData = { n_value: formNpk.querySelector('#n-input').value, p_value: formNpk.querySelector('#p-input').value, k_value: formNpk.querySelector('#k-input').value, };
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/analyze-npk`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) });
                        const data = await response.json();
                        if (data.success) {
                            let html = '<h3>Hasil Analisis Tanah:</h3><ul class="item-list">';
                            const labels = { 'Rendah': 'label-rendah', 'Optimal': 'label-optimal', 'Berlebih': 'label-berlebih' };
                            for (const [n, r] of Object.entries(data.analysis)) { html += `<li><strong>${n}:</strong> <span class="label ${labels[r.label]||''}">${r.label}</span><br><small>${r.rekomendasi}</small></li>`; }
                            html += '</ul><p><small>Data ini telah disimpan.</small></p>';
                            resultNpkDiv.innerHTML = html;
                        } else { resultNpkDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`; }
                    } catch (error) { resultNpkDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Gagal terhubung.</p>`; }
                });
            }

            // --- Logika untuk Modul 4 (Intelijen Harga Pasar) ---
            const priceForm = document.getElementById('price-form'), resultPriceDiv = document.getElementById('result-price');
            if(priceForm) {
                priceForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    console.log('üìù Modul 4: Price Check: Form submitted!');
                    resultPriceDiv.innerHTML = '<p>Mengambil data harga...</p>';
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/get-prices`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ commodity: priceForm.querySelector('#price-commodity-select').value }) });
                        const data = await response.json();
                        if (data.success) {
                            let html = `<h3>Data Harga: ${data.data.name}</h3><ul class="item-list">`;
                            for (const [m, p] of Object.entries(data.data.prices)) { html += `<li class="price-item"><span class="item-name">${m}</span><span class="item-value">${formatRupiah(p)} / ${data.data.unit}</span></li>`; }
                            html += '</ul>';
                            resultPriceDiv.innerHTML = html;
                        } else { resultPriceDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`; }
                    } catch (error) { resultPriceDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Gagal terhubung.</p>`; }
                });
            }

            // --- Logika untuk Modul 5 (Basis Pengetahuan Budidaya) ---
            const knowledgeSelect = document.getElementById('knowledge-commodity-select'), resultKnowledgeDiv = document.getElementById('result-knowledge');
            if(knowledgeSelect) {
                async function fetchKnowledge() {
                    if (!knowledgeSelect.value) return;
                    resultKnowledgeDiv.innerHTML = '<p>Mengambil data...</p>';
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/get-knowledge`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ commodity: knowledgeSelect.value }) });
                        const data = await response.json();
                        if (data.success) {
                            const kd = data.data;
                            let html = `<h3>${kd.icon} ${kd.name}</h3><div class="tabs">`;
                            Object.keys(kd.data).forEach((t, i) => { html += `<button class="tab-button ${i===0?'active':''}" onclick="openTab(event, 'k-${t.replace(/\s+/g,'-')}', this)">${t}</button>`; });
                            html += '</div>';
                            Object.entries(kd.data).forEach(([t, c], i) => {
                                html += `<div id="k-${t.replace(/\s+/g,'-')}" class="tab-content ${i===0?'active':''}"><ul>`;
                                c.forEach(item => { html += `<li>${item}</li>`; });
                                html += '</ul></div>';
                            });
                            resultKnowledgeDiv.innerHTML = html;
                        } else { resultKnowledgeDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`; }
                    } catch (error) { resultKnowledgeDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Gagal terhubung.</p>`; }
                }
                knowledgeSelect.addEventListener('change', fetchKnowledge);
            }

            // --- Logika untuk Modul 7 (Kalkulator Pupuk Holistik) ---
            const fertForm = document.getElementById('fertilizer-calculator-form'), resultFertDiv = document.getElementById('result-fertilizer');
            if(fertForm) {
                fertForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    resultFertDiv.innerHTML = '<p>Menghitung kebutuhan...</p>';
                    const requestData = { commodity: fertForm.querySelector('#fert-commodity-select').value, area_sqm: fertForm.querySelector('#area-input').value, ph_tanah: fertForm.querySelector('#fert-ph-input').value };
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/calculate-fertilizer`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) });
                        const data = await response.json();
                        if (data.success) {
                            const { data: d, commodity_name: cn, area_sqm: a } = data;
                            let html = `<h3>Rekomendasi Pupuk untuk ${cn}</h3><p>Lahan <strong>${a} m¬≤</strong> dengan pH <strong>${requestData.ph_tanah}</strong>:</p>`;
                            const sections = { 'Perbaikan Tanah': d.perbaikan_tanah, 'Pupuk Organik': d.organik, 'Pupuk Anorganik': d.anorganik };
                            for (const [title, content] of Object.entries(sections)) {
                                if (content && Object.keys(content).length > 0) {
                                    html += `<h4>${title}:</h4><ul class="item-list">`;
                                    for (const [fert, amount] of Object.entries(content)) { html += `<li class="fertilizer-item"><span class="item-name">${fert}</span><span class="item-value">${amount} kg</span></li>`; }
                                    html += '</ul>';
                                }
                            }
                            html += '<br><small>Catatan: Rekomendasi pupuk dasar. Sesuaikan dengan kondisi tanah dan fase pertumbuhan.</small>';
                            resultFertDiv.innerHTML = html;
                        } else { resultFertDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`; }
                    } catch (error) { resultFertDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Gagal terhubung.</p>`; }
                });
            }

            // --- Logika untuk Modul 8 (Pustaka Dokumen) ---
            const pdfForm = document.getElementById('pdf-upload-form'), pdfStatus = document.getElementById('pdf-upload-status'), pdfList = document.getElementById('pdf-list');
            if(pdfForm) {
                async function fetchPdfs() {
                    pdfList.innerHTML = '<p>Memuat daftar...</p>';
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/get-pdfs`);
                        const data = await response.json();
                        if (data.success && data.files) {
                            if (data.files.length > 0) {
                                let html = '<ul class="item-list">';
                                data.files.forEach(f => { html += `<li class="pdf-item"><a href="${baseUrl}${apiPrefix}/view-pdf/${f}" target="_blank">${f}</a></li>`; });
                                html += '</ul>';
                                pdfList.innerHTML = html;
                            } else { pdfList.innerHTML = '<p>Belum ada dokumen.</p>'; }
                        } else { pdfList.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`; }
                    } catch (error) { pdfList.innerHTML = `<p style="color: red;">Gagal terhubung.</p>`; }
                }
                fetchPdfs();
                pdfForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    pdfStatus.style.display = 'block';
                    pdfStatus.innerHTML = '<p>Mengunggah...</p>';
                    const formData = new FormData(pdfForm);
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/upload-pdf`, { method: 'POST', body: formData });
                        const data = await response.json();
                        if (data.success) {
                            pdfStatus.innerHTML = `<p style="color: green;">Sukses: ${data.message}</p>`;
                            pdfForm.reset();
                            fetchPdfs();
                        } else { pdfStatus.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`; }
                    } catch (error) { pdfStatus.innerHTML = `<p style="color: red;">Gagal terhubung.</p>`; }
                });
            }

            // --- Logika untuk Modul 9 (Rekomendasi Terpadu) ---
            const intForm = document.getElementById('integrated-recommendation-form'), resultInt = document.getElementById('result-integrated');
            if(intForm) {
                intForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    resultInt.innerHTML = '<p>Menyusun rekomendasi...</p>';
                    const requestData = { ketinggian: intForm.querySelector('#ketinggian-select').value, iklim: intForm.querySelector('#iklim-select').value, fase: intForm.querySelector('#fase-select').value, masalah: intForm.querySelector('#masalah-select').value };
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/get-integrated-recommendation`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) });
                        const data = await response.json();
                        if (data.success) {
                            let html = '<h3>Rekomendasi Strategis:</h3>';
                            html += `<h4>üå± Pemilihan Bibit</h4><p>${data.data.bibit}</p>`;
                            html += `<h4>üåø Pemupukan</h4><p>${data.data.pemupukan}</p>`;
                            html += `<h4>üõ°Ô∏è Penyemprotan</h4><p>${data.data.penyemprotan}</p>`;
                            resultInt.innerHTML = html;
                        } else { resultInt.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`; }
                    } catch (error) { resultInt.innerHTML = `<p style="color: red;">Gagal terhubung.</p>`; }
                });
            }

            // --- Logika untuk Modul 10 (Strategi Penyemprotan) ---
            const sprayForm = document.getElementById('spraying-strategy-form'), resultSpray = document.getElementById('result-spraying');
            if(sprayForm) {
                sprayForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    resultSpray.innerHTML = '<p>Menyusun rencana...</p>';
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/get-spraying-recommendation`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pest: sprayForm.querySelector('#pest-select').value }) });
                        const data = await response.json();
                        if (data.success) {
                            const d = data.data;
                            let html = `<h3>${d.strategy.name}</h3><p>${d.strategy.description}</p>`;
                            d.strategy.cycles.forEach(c => { html += `<div class="strategy-cycle"><h4>${c.weeks}: ${c.level}</h4><p><strong>Bahan Aktif:</strong> ${c.active_ingredient}<br><strong>Grup IRAC:</strong> ${c.irac_code}<br><strong>SOP:</strong> ${c.sop}</p></div>`; });
                            html += `<h3>${d.protocol.title}</h3><ul>`;
                            d.protocol.steps.forEach(s => { html += `<li>${s}</li>`; });
                            html += '</ul>';
                            resultSpray.innerHTML = html;
                        } else { resultSpray.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`; }
                    } catch (error) { resultSpray.innerHTML = `<p style="color: red;">Gagal terhubung.</p>`; }
                });
            }

            // --- Logika untuk Modul 11 (Grafik Harga) ---
            const histPriceForm = document.getElementById('historical-price-form'), resultHistPrice = document.getElementById('result-historical-price');
            let priceChart;
            if(histPriceForm) {
                const chartCanvas = document.getElementById('price-chart').getContext('2d');
                histPriceForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    resultHistPrice.querySelector('p').textContent = 'Memvisualisasikan data...';
                    const requestData = { commodity: histPriceForm.querySelector('#historical-commodity-select').value, range: histPriceForm.querySelector('#time-range-select').value };
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/get-historical-prices`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) });
                        const data = await response.json();
                        if (data.success) {
                            resultHistPrice.querySelector('p').textContent = `Grafik tren harga:`;
                            if (priceChart) priceChart.destroy();
                            priceChart = new Chart(chartCanvas, {
                                type: 'line',
                                data: {
                                    labels: data.labels,
                                    datasets: [{ label: 'Harga (Rp)', data: data.prices, borderColor: 'rgba(46, 125, 50, 1)', backgroundColor: 'rgba(76, 175, 80, 0.2)', borderWidth: 2, fill: true, tension: 0.3 }]
                                },
                                options: { responsive: true, scales: { y: { ticks: { callback: (v) => formatRupiah(v) } } } }
                            });
                        } else { resultHistPrice.querySelector('p').textContent = `Error: ${data.error}`; }
                    } catch (error) { resultHistPrice.querySelector('p').textContent = 'Error: Gagal terhubung.'; }
                });
            }
            
            // --- Logika untuk Modul 12 (Ensiklopedia Komoditas) ---
            const guideForm = document.getElementById('guide-form'), resultGuideDiv = document.getElementById('result-guide');
            if(guideForm) {
                guideForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    resultGuideDiv.style.display = 'block';
                    resultGuideDiv.innerHTML = '<p>Memuat panduan...</p>';
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/get-commodity-guide`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ commodity: guideForm.querySelector('#guide-commodity-select').value }) });
                        const data = await response.json();
                        if (data.success) {
                            const gd = data.data;
                            let html = `<h2>${gd.icon} Panduan Lengkap: ${gd.name}</h2><p>${gd.description}</p>`;
                            html += '<div class="tabs">';
                            html += `<button class="tab-button active" onclick="openTab(event, 'sop-budidaya', this)">SOP Budidaya</button>`;
                            html += `<button class="tab-button" onclick="openTab(event, 'analisis-bisnis', this)">Analisis Bisnis</button>`;
                            html += '</div>';
                            html += `<div id="sop-budidaya" class="tab-content active">`;
                            for (const [phase, steps] of Object.entries(gd.sop)) {
                                html += `<h3>${phase}</h3><ul>`;
                                steps.forEach(step => { html += `<li>${step}</li>`; });
                                html += `</ul>`;
                            }
                            html += `</div>`;
                            const analysis = gd.business_analysis;
                            html += `<div id="analisis-bisnis" class="tab-content"><h3>${analysis.title}</h3><p><strong>Asumsi:</strong> Lahan ${analysis.assumptions.Luas_Lahan}, populasi ${analysis.assumptions.Populasi_Tanaman}.</p>`;
                            html += `<h4>Estimasi Biaya Produksi</h4><table><tr><th>Komponen</th><th>Kebutuhan</th><th style="text-align:right;">Biaya</th></tr>`;
                            let totalCost = 0;
                            analysis.costs.forEach(i => { html += `<tr><td>${i.item}</td><td>${i.amount}</td><td class="cost">${formatRupiah(i.cost)}</td></tr>`; totalCost += i.cost; });
                            html += `<tr><td colspan="2" class="total-cost"><strong>Total Biaya</strong></td><td class="total-cost"><strong>${formatRupiah(totalCost)}</strong></td></tr></table>`;
                            html += `<h4>Simulasi Pendapatan</h4><table><tr><th>Skenario Harga</th><th>Panen Konservatif</th><th>Panen Optimal</th></tr>`;
                            analysis.revenue_scenarios.forEach(s => {
                                const revCons = analysis.yield_potential[0].total_yield_kg * s.price_per_kg;
                                const revOpt = analysis.yield_potential[1].total_yield_kg * s.price_per_kg;
                                html += `<tr><td>${s.price_level} (${formatRupiah(s.price_per_kg)}/kg)</td><td>${formatRupiah(revCons)}</td><td>${formatRupiah(revOpt)}</td></tr>`;
                            });
                            html += `</table><br><small><strong>Disclaimer:</strong> Angka ini adalah estimasi.</small></div>`;
                            resultGuideDiv.innerHTML = html;
                        } else { resultGuideDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`; }
                    } catch (error) { resultGuideDiv.innerHTML = `<p style="color: red;">Gagal terhubung.</p>`; }
                });
            }

            // --- Logika untuk Modul 13 (Pusat Pengetahuan pH) ---
            const showPhBtn = document.getElementById('show-ph-info-btn'), resultPhDiv = document.getElementById('result-ph-info');
            if(showPhBtn) {
                showPhBtn.addEventListener('click', async (event) => {
                    event.preventDefault();
                    if (resultPhDiv.style.display === 'block') {
                        resultPhDiv.style.display = 'none';
                        showPhBtn.textContent = 'Tampilkan Informasi Lengkap';
                        return;
                    }
                    resultPhDiv.style.display = 'block';
                    showPhBtn.textContent = 'Sembunyikan Informasi';
                    resultPhDiv.innerHTML = '<p>Memuat informasi...</p>';
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/get-ph-info`);
                        const data = await response.json();
                        if (data.success) {
                            const pd = data.data;
                            let html = `<h2>${pd.icon} ${pd.title}</h2><div class="tabs">`;
                            Object.keys(pd.sections).forEach((k, i) => { html += `<button class="tab-button ${i===0?'active':''}" onclick="openTab(event, 'ph-${k.replace(/[^a-zA-Z0-9]/g, '-')}', this)">${pd.sections[k].title}</button>`; });
                            html += '</div>';
                            Object.entries(pd.sections).forEach(([k, s], i) => {
                                html += `<div id="ph-${k.replace(/[^a-zA-Z0-9]/g, '-')}" class="tab-content ${i===0?'active':''}"><ul>`;
                                s.content.forEach(item => { html += `<li>${item}</li>`; });
                                html += `</ul></div>`;
                            });
                            resultPhDiv.innerHTML = html;
                        } else { resultPhDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`; }
                    } catch (error) { resultPhDiv.innerHTML = `<p style="color: red;">Gagal terhubung.</p>`; }
                });
            }

            // --- Logika untuk Modul 14 (Rekomendasi Tanaman) ---
            const cropForm = document.getElementById('crop-recommendation-form'), resultCropDiv = document.getElementById('result-crop');
            if(cropForm) {
                cropForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    resultCropDiv.innerHTML = '<p>Menganalisis data dan mencari rekomendasi terbaik...</p>';
                    const requestData = {
                        n_value: document.getElementById('crop-n-input').value,
                        p_value: document.getElementById('crop-p-input').value,
                        k_value: document.getElementById('crop-k-input').value,
                        temperature: document.getElementById('crop-temp-input').value,
                        humidity: document.getElementById('crop-humidity-input').value,
                        ph: document.getElementById('crop-ph-input').value,
                        rainfall: document.getElementById('crop-rainfall-input').value
                    };
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/recommend-crop`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestData)
                        });
                        const responseData = await response.json();
                        if (responseData.success) {
                            resultCropDiv.innerHTML = `<h3>Rekomendasi Tanaman Optimal</h3><p style="font-size: 1.5em; text-align: center; font-weight: bold; color: var(--primary-color);">${responseData.recommended_crop}</p><p><small>Rekomendasi ini dihasilkan oleh model Machine Learning berdasarkan data yang Anda masukkan.</small></p>`;
                        } else {
                            resultCropDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${responseData.error}</p>`;
                        }
                    } catch (error) {
                        resultCropDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Tidak dapat terhubung ke server.</p>`;
                    }
                });
            }
            
            // --- Logika untuk Modul 15 (Prediksi Panen) ---
            const yieldForm = document.getElementById('yield-prediction-form'), resultYieldDiv = document.getElementById('result-yield');
            if(yieldForm) {
                yieldForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    resultYieldDiv.innerHTML = '<p>Menganalisis data dan membuat prediksi...</p>';
                    const requestData = {
                        nitrogen: document.getElementById('yield-n-input').value,
                        phosphorus: document.getElementById('yield-p-input').value,
                        potassium: document.getElementById('yield-k-input').value,
                        temperature: document.getElementById('yield-temp-input').value,
                        rainfall: document.getElementById('yield-rainfall-input').value,
                        ph: document.getElementById('yield-ph-input').value,
                    };
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/predict-yield`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestData)
                        });
                        const responseData = await response.json();
                        if (responseData.success) {
                            resultYieldDiv.innerHTML = `<h3>Estimasi Potensi Hasil Panen</h3><p style="font-size: 1.8em; text-align: center; font-weight: bold; color: var(--primary-color);">${responseData.predicted_yield_ton_ha} ton/ha</p><p><small>Estimasi ini dihasilkan oleh model Machine Learning berdasarkan data yang Anda masukkan.</small></p>`;
                        } else {
                            resultYieldDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${responseData.error}</p>`;
                        }
                    } catch (error) {
                        resultYieldDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Tidak dapat terhubung ke server.</p>`;
                    }
                });
            }

             // --- Logika untuk Modul 16 (Prediksi Panen XAI) ---
            const xaiYieldForm = document.getElementById('xai-yield-prediction-form'), resultXaiYieldDiv = document.getElementById('result-xai-yield');
            let importanceChart; 
            if(xaiYieldForm) {
                xaiYieldForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    resultXaiYieldDiv.style.display = 'block';
                    resultXaiYieldDiv.innerHTML = '<p>Menganalisis data dengan XAI...</p>';

                    const requestData = {
                        nitrogen: document.getElementById('xai-nitrogen').value,
                        phosphorus: document.getElementById('xai-phosphorus').value,
                        potassium: document.getElementById('xai-potassium').value,
                        temperature: document.getElementById('xai-temperature').value,
                        rainfall: document.getElementById('xai-rainfall').value,
                        ph: document.getElementById('xai-ph').value,
                    };

                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/predict-yield-advanced`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestData)
                        });
                        const data = await response.json();

                        if (data.success) {
                            if (importanceChart) {
                                importanceChart.destroy();
                            }

                            let htmlResult = `
                                <h3>Hasil Prediksi & Analisis</h3>
                                <p style="font-size: 1.8em; text-align: center; font-weight: bold; color: var(--primary-color);">
                                    Estimasi Panen: ${data.predicted_yield_ton_ha} ton/ha
                                </p>
                                
                                <h4>Faktor Pendorong & Penghambat (Analisis SHAP)</h4>
                                <p>Analisis ini menjelaskan mengapa prediksi Anda berbeda dari rata-rata (${data.base_value} ton/ha).</p>
                                <ul class="item-list">`;
                            
                            for(const [feature, value] of Object.entries(data.shap_values)) {
                                const change = value / 1000; 
                                const direction = change >= 0 ? 'Meningkatkan' : 'Menurunkan';
                                const cssClass = change >= 0 ? 'shap-positive' : 'shap-negative';
                                htmlResult += `<li class="shap-item"><span>${feature}</span> <span class="${cssClass}">${direction} estimasi sebesar ${Math.abs(change).toFixed(2)} ton/ha</span></li>`;
                            }
                            
                            htmlResult += `</ul>
                                
                                <h4>Faktor Paling Berpengaruh (Secara Umum)</h4>
                                <canvas id="importance-chart"></canvas>
                            `;

                            resultXaiYieldDiv.innerHTML = htmlResult;

                            const chartCtx = document.getElementById('importance-chart').getContext('2d');
                            const labels = data.feature_importances.map(item => item[0]);
                            const values = data.feature_importances.map(item => item[1]);
                            
                            importanceChart = new Chart(chartCtx, {
                                type: 'bar',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Tingkat Kepentingan',
                                        data: values,
                                        backgroundColor: 'rgba(76, 175, 80, 0.6)',
                                        borderColor: 'rgba(46, 125, 50, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: true,
                                    plugins: {
                                        legend: { display: false },
                                        title: { display: true, text: 'Faktor yang Paling Memengaruhi Hasil Panen' }
                                    }
                                }
                            });

                        } else {
                            resultXaiYieldDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`;
                        }
                    } catch (error) {
                        console.error('Error fetching XAI prediction:', error);
                        resultXaiYieldDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Tidak dapat terhubung ke server.</p>`;
                    }
                });
            }

             // --- Logika untuk Modul 17 (Kalkulator Konversi Pupuk) ---
            const fertConversionForm = document.getElementById('fertilizer-conversion-form'), resultFertConversionDiv = document.getElementById('result-fertilizer-conversion');
            if(fertConversionForm) {
                fertConversionForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    resultFertConversionDiv.innerHTML = '<p>Menghitung konversi...</p>';
                    const requestData = {
                        nutrient_needed: document.getElementById('nutrient-needed-select').value,
                        nutrient_amount_kg: document.getElementById('nutrient-amount-input').value,
                        fertilizer_type: document.getElementById('fertilizer-type-select').value
                    };
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/calculate-fertilizer-bags`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) });
                        const data = await response.json();
                        if (data.success) {
                            resultFertConversionDiv.innerHTML = `<h3>Hasil Perhitungan</h3><p>Untuk memenuhi kebutuhan <strong>${data.nutrient_amount_kg} kg</strong> unsur hara <strong>${data.nutrient_needed}</strong>, Anda memerlukan:</p><p style="font-size: 1.8em; text-align: center; font-weight: bold; color: var(--primary-color);">${data.required_fertilizer_kg} kg pupuk ${data.fertilizer_name}</p>`;
                        } else {
                            resultFertConversionDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`;
                        }
                    } catch (error) {
                        resultFertConversionDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Tidak dapat terhubung ke server.</p>`;
                    }
                });
            }
            
            // --- Logika untuk Modul 18 (Diagnostik Gejala Cerdas) ---
            const startBtn = document.getElementById('start-diagnostic-btn'), questionsDiv = document.getElementById('diagnostic-questions'), resultDiv = document.getElementById('diagnostic-result');
            let diagnosticTree = null;
            if(startBtn) {
                async function startDiagnostic() {
                    startBtn.style.display = 'none';
                    questionsDiv.style.display = 'block';
                    resultDiv.style.display = 'none';
                    resultDiv.innerHTML = '';
                    questionsDiv.innerHTML = '<p>Memuat data diagnostik...</p>';
                    try {
                        if (!diagnosticTree) {
                            const response = await fetch(`${baseUrl}${apiPrefix}/get-diagnostic-tree`);
                            const responseData = await response.json();
                            if (responseData.success) {
                                diagnosticTree = responseData.data;
                            } else {
                                throw new Error(responseData.error);
                            }
                        }
                        renderQuestion(diagnosticTree.start, []);
                    } catch (error) {
                        questionsDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${error.message}</p>`;
                    }
                }
                function renderQuestion(node, path) {
                    questionsDiv.innerHTML = `<h4>${node.question}</h4>`;
                    for (const [key, nextNode] of Object.entries(node.options)) {
                        const button = document.createElement('button');
                        button.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        button.classList.add('option-button');
                        button.onclick = () => {
                            if (typeof nextNode === 'string') {
                                renderResult(nextNode);
                            } else {
                                renderQuestion(nextNode, [...path, key]);
                            }
                        };
                        questionsDiv.appendChild(button);
                    }
                }
                function renderResult(diagnosis) {
                    questionsDiv.style.display = 'none';
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `<h3>Hasil Diagnosis</h3><p>${diagnosis}</p><button class="option-button" id="restart-diagnostic-btn">Mulai Lagi</button>`;
                    document.getElementById('restart-diagnostic-btn').onclick = () => {
                         startBtn.style.display = 'block';
                         questionsDiv.style.display = 'none';
                         resultDiv.style.display = 'none';
                    };
                }
                startBtn.addEventListener('click', startDiagnostic);
            }

            // --- Logika untuk Modul 19 (Perencana Hasil Panen) ---
            const yieldPlanForm = document.getElementById('yield-plan-form'), resultYieldPlanDiv = document.getElementById('result-yield-plan');
            if(yieldPlanForm) {
                yieldPlanForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    resultYieldPlanDiv.innerHTML = '<p>Mencari resep lahan optimal...</p>';
                    const requestData = {
                        commodity: document.getElementById('plan-commodity-select').value,
                        target_yield: document.getElementById('plan-target-yield-input').value
                    };
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/generate-yield-plan`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestData)
                        });
                        const data = await response.json();
                        if (data.success) {
                            let htmlResult = `<h3>Rekomendasi Kondisi Lahan</h3><p>Untuk mencapai target panen sekitar <strong>${requestData.target_yield} ton/ha</strong>, berikut adalah resep kondisi lahan berdasarkan data kami yang paling mendekati:</p><ul class="item-list mt-4">`;
                            for(const [key, value] of Object.entries(data.plan)) {
                                 htmlResult += `<li class="plan-item"><span class="plan-item-label">${key}</span><span class="plan-item-value">${value}</span></li>`;
                            }
                            htmlResult += `</ul><br><small><strong>Disclaimer:</strong> Ini adalah target berdasarkan data historis, bukan jaminan.</small>`;
                            resultYieldPlanDiv.innerHTML = htmlResult;
                        } else {
                            resultYieldPlanDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`;
                        }
                    } catch (error) {
                        resultYieldPlanDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Gagal terhubung ke server.</p>`;
                    }
                });
            }

            // --- Logika untuk Modul 21 (Analis Risiko Keberhasilan) ---
            const successPredictionForm = document.getElementById('success-prediction-form'), resultSuccessPredictionDiv = document.getElementById('result-success-prediction');
            if (successPredictionForm) {
                successPredictionForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    console.log('üìù Modul 21: Success Prediction form submitted!');
                    resultSuccessPredictionDiv.innerHTML = '<p>Menganalisis probabilitas keberhasilan...</p>';
                    
                    const requestData = {
                        nitrogen: document.getElementById('sp-nitrogen').value,
                        phosphorus: document.getElementById('sp-phosphorus').value,
                        potassium: document.getElementById('sp-potassium').value,
                        temperature: document.getElementById('sp-temperature').value,
                        rainfall: document.getElementById('sp-rainfall').value,
                        ph: document.getElementById('sp-ph').value,
                        penggunaan_benih: document.getElementById('sp-benih').value,
                        aplikasi_organik: document.getElementById('sp-organik').value,
                        manajemen_gulma: document.getElementById('sp-gulma').value
                    };
                    
                    try {
                        const response = await fetch(`${baseUrl}${apiPrefix}/predict-success`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestData)
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            const statusColor = data.status === "Berhasil" ? "text-green-600" : "text-red-600";
                            resultSuccessPredictionDiv.innerHTML = `
                                <h3>Hasil Analisis Risiko</h3>
                                <p>Berdasarkan parameter yang Anda masukkan, status rencana tanam Anda adalah:</p>
                                <p style="font-size: 1.8em; text-align: center; font-weight: bold;" class="${statusColor}">${data.status}</p>
                                <p class="text-center">Dengan probabilitas keberhasilan sebesar <strong>${data.probability_of_success}%</strong></p>
                            `;
                        } else {
                            resultSuccessPredictionDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`;
                        }
                    } catch (error) {
                        console.error('Error fetching success probability:', error);
                        resultSuccessPredictionDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Tidak dapat terhubung ke server.</p>`;
                    }
                });
            }
            
            // --- Logika untuk Modul 20 (Dokter Tanaman Canggih - Roboflow AI) ---
            const advancedDiseaseForm = document.getElementById('advanced-disease-form');
            const resultAdvancedDiseaseDiv = document.getElementById('result-advanced-disease');
            if (advancedDiseaseForm) {
                advancedDiseaseForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); 
                    console.log('üìù Modul 20: Roboflow form submitted!');
                    resultAdvancedDiseaseDiv.innerHTML = '<p>Menganalisis dengan Roboflow AI...</p>';
                    const fileInput = document.getElementById('disease-image-input');
                    const file = fileInput.files[0];
                    if (!file) {
                        resultAdvancedDiseaseDiv.innerHTML = '<p style="color: red;"><strong>Error:</strong> Silakan pilih file gambar terlebih dahulu.</p>';
                        return;
                    }
                    
                    // --- Logika Roboflow (Client-Side) ---
                    const roboflowApiKey = "jPdPobkMUhG9yEKohrrP"; 
                    const roboflowApiUrl = "https://serverless.roboflow.com";
                    const roboflowWorkspace = "andriyanto39";
                    const roboflowWorkflow = "detect-and-classify";

                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = async () => {
                        const base64Image = reader.result.split(',')[1];
                        const requestUrl = `${roboflowApiUrl}/${roboflowWorkspace}/${roboflowWorkflow}?api_key=${roboflowApiKey}&format=json`;
                        try {
                            const response = await fetch(requestUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ image: { type: "base64", value: base64Image } })
                            });
                            const data = await response.json();
                            if (response.ok) {
                                displayRoboflowResults(data);
                            } else {
                                resultAdvancedDiseaseDiv.innerHTML = `<p style="color: red;"><strong>Error dari Roboflow:</strong> ${data.message || 'Error tidak diketahui.'}</p>`;
                            }
                        } catch (error) { resultAdvancedDiseaseDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Tidak dapat terhubung ke server Roboflow.</p>`; }
                    };
                    reader.onerror = (error) => {
                         resultAdvancedDiseaseDiv.innerHTML = `<p style="color: red;"><strong>Error:</strong> Gagal membaca file gambar.</p>`;
                    };
                });

                function displayRoboflowResults(results) {
                    let html = '<h3>Hasil Diagnosis dari Roboflow AI</h3>';
                    if (results && results.outputs && results.outputs.length > 0) {
                        html += '<ul style="list-style-type: none; padding-left: 0;">';
                        results.outputs.forEach((output, index) => {
                            const detection = output.detection;
                            const classification = output.classification;
                            html += `<li class="mb-4 p-4 border rounded-lg bg-white">`;
                            html += `<strong class="text-lg text-emerald-700">Deteksi #${index + 1}</strong><br>`;
                            if (detection && detection.predictions && detection.predictions.length > 0) {
                                const pred = detection.predictions[0];
                                html += `<strong>Objek Terdeteksi:</strong> ${pred.class} (Kepercayaan: ${Math.round(pred.confidence * 100)}%)<br>`;
                            } else { html += `<strong>Objek Terdeteksi:</strong> Tidak ada.<br>`; }
                             if (classification && classification.predictions && classification.predictions.length > 0) {
                                const topClass = classification.predictions[0];
                                html += `<strong>Klasifikasi Penyakit:</strong> ${topClass.class} (Kepercayaan: ${Math.round(topClass.confidence * 100)}%)`;
                            } else { html += `<strong>Klasifikasi Penyakit:</strong> Tidak ada.`; }
                            html += `</li>`;
                        });
                        html += '</ul>';
                    } else {
                         html += '<p>Tidak ada hasil deteksi atau klasifikasi yang ditemukan dalam gambar.</p>';
                    }
                    resultAdvancedDiseaseDiv.innerHTML = html;
                }
            }

        }); // --- TUTUP DOMCONTENTLOADED UTAMA ---
    </script>
</body>
</html>

